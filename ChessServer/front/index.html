<!doctype html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>صفحه شطرنج</title>
    <script src="/_sdk/element_sdk.js"></script>
    <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Vazirmatn', 'Segoe UI', Tahoma, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        html {
            height: 100%;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 90%;
        }

        h1 {
            text-align: center;
            color: #2d3748;
            margin: 0 0 10px 0;
            font-size: 32px;
        }

        .turn-indicator {
            text-align: center;
            font-size: 18px;
            color: #4a5568;
            margin-bottom: 20px;
            font-weight: 600;
        }

            .turn-indicator span {
                display: inline-block;
                padding: 8px 20px;
                border-radius: 20px;
                background: #edf2f7;
            }

        .chessboard {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 0;
            border: 3px solid #2d3748;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 1;
            max-width: 500px;
            margin: 0 auto;
        }

        .square {
            aspect-ratio: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

            .square.light {
                background-color: #f0d9b5;
            }

            .square.dark {
                background-color: #b58863;
            }

            .square.selected {
                background-color: #7fb069 !important;
                box-shadow: inset 0 0 0 3px #5a8c4a;
            }

            .square.valid-move {
                position: relative;
            }

                .square.valid-move::after {
                    content: '';
                    position: absolute;
                    width: 30%;
                    height: 30%;
                    background-color: rgba(127, 176, 105, 0.6);
                    border-radius: 50%;
                }

                .square.valid-move.has-piece::after {
                    width: 90%;
                    height: 90%;
                    background-color: transparent;
                    border: 4px solid rgba(127, 176, 105, 0.8);
                    border-radius: 50%;
                }

            .square:hover {
                filter: brightness(0.95);
            }

        .piece {
            pointer-events: none;
        }
    </style>
    <style>
        @view-transition {
            navigation: auto;
        }
    </style>
    <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
    <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
</head>
<body>
    <div class="container">
        <h1 id="board-title">صفحه شطرنج</h1>
        <div class="turn-indicator">
            <span id="turn-text">نوبت بازی: <span id="current-turn">سفید</span></span>
        </div>
        <div class="chessboard" id="chessboard"></div>
    </div>
    <script>
        const defaultConfig = {
            board_title: "صفحه شطرنج",
            turn_text: "نوبت بازی:",
            background_color: "#667eea",
            surface_color: "#ffffff",
            text_color: "#2d3748",
            primary_action_color: "#7fb069",
            secondary_action_color: "#4a5568"
        };

        const pieces = {
            white: {
                king: '♔',
                queen: '♕',
                rook: '♖',
                bishop: '♗',
                knight: '♘',
                pawn: '♙'
            },
            black: {
                king: '♚',
                queen: '♛',
                rook: '♜',
                bishop: '♝',
                knight: '♞',
                pawn: '♟'
            }
        };

        let board = [];
        let selectedSquare = null;
        let currentTurn = 'white';

        function initializeBoard() {
            board = [
                ['♜', '♞', '♝', '♛', '♚', '♝', '♞', '♜'],
                ['♟', '♟', '♟', '♟', '♟', '♟', '♟', '♟'],
                ['', '', '', '', '', '', '', ''],
                ['', '', '', '', '', '', '', ''],
                ['', '', '', '', '', '', '', ''],
                ['', '', '', '', '', '', '', ''],
                ['♙', '♙', '♙', '♙', '♙', '♙', '♙', '♙'],
                ['♖', '♘', '♗', '♕', '♔', '♗', '♘', '♖']
            ];
        }

        function getPieceColor(piece) {
            if (!piece) return null;
            return ['♔', '♕', '♖', '♗', '♘', '♙'].includes(piece) ? 'white' : 'black';
        }

        function getPieceType(piece) {
            const types = {
                '♔': 'king', '♚': 'king',
                '♕': 'queen', '♛': 'queen',
                '♖': 'rook', '♜': 'rook',
                '♗': 'bishop', '♝': 'bishop',
                '♘': 'knight', '♞': 'knight',
                '♙': 'pawn', '♟': 'pawn'
            };
            return types[piece];
        }

        /*function getValidMoves(row, col) {
          const piece = board[row][col];
          if (!piece) return [];

          const pieceType = getPieceType(piece);
          const pieceColor = getPieceColor(piece);
          const moves = [];

          function addMove(r, c) {
            if (r >= 0 && r < 8 && c >= 0 && c < 8) {
              const targetPiece = board[r][c];
              if (!targetPiece || getPieceColor(targetPiece) !== pieceColor) {
                moves.push([r, c]);
                return !targetPiece;
              }
            }
            return false;
          }

          if (pieceType === 'pawn') {
            const direction = pieceColor === 'white' ? -1 : 1;
            const startRow = pieceColor === 'white' ? 6 : 1;

            if (!board[row + direction]?.[col]) {
              moves.push([row + direction, col]);
              if (row === startRow && !board[row + 2 * direction]?.[col]) {
                moves.push([row + 2 * direction, col]);
              }
            }

            [-1, 1].forEach(dc => {
              const newRow = row + direction;
              const newCol = col + dc;
              if (board[newRow]?.[newCol] && getPieceColor(board[newRow][newCol]) !== pieceColor) {
                moves.push([newRow, newCol]);
              }
            });
          }

          if (pieceType === 'rook') {
            [[1,0], [-1,0], [0,1], [0,-1]].forEach(([dr, dc]) => {
              let r = row + dr, c = col + dc;
              while (addMove(r, c)) {
                r += dr;
                c += dc;
              }
            });
          }

          if (pieceType === 'bishop') {
            [[1,1], [1,-1], [-1,1], [-1,-1]].forEach(([dr, dc]) => {
              let r = row + dr, c = col + dc;
              while (addMove(r, c)) {
                r += dr;
                c += dc;
              }
            });
          }

          if (pieceType === 'queen') {
            [[1,0], [-1,0], [0,1], [0,-1], [1,1], [1,-1], [-1,1], [-1,-1]].forEach(([dr, dc]) => {
              let r = row + dr, c = col + dc;
              while (addMove(r, c)) {
                r += dr;
                c += dc;
              }
            });
          }

          if (pieceType === 'knight') {
            [[2,1], [2,-1], [-2,1], [-2,-1], [1,2], [1,-2], [-1,2], [-1,-2]].forEach(([dr, dc]) => {
              addMove(row + dr, col + dc);
            });
          }

          if (pieceType === 'king') {
            [[1,0], [-1,0], [0,1], [0,-1], [1,1], [1,-1], [-1,1], [-1,-1]].forEach(([dr, dc]) => {
              addMove(row + dr, col + dc);
            });
          }

          return moves;
        }*/

        async function getValidMoves(row, col) {
            // خانه را به فرمت شطرنجی مثل "b2" تبدیل می‌کنیم
            const square = String.fromCharCode(97 + col) + (8 - row);

            try {
                const response = await fetch("http://localhost:5186/api/Chess/pickup", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ square }),
                });

                if (!response.ok) {
                    console.error("Server error:", response.status);
                    return [];
                }

                const data = await response.json();

                // انتظار پاسخ در قالب:
                // {
                //   "piece": "White Pawn",
                //   "from": "b2",
                //   "moves": ["b3", "b4"]
                // }

                if (!data.moves) return [];

                // حالا حرکات را از فرم ["b3","b4"] به مختصات [row,col] برمی‌گردانیم
                const moves = data.moves.map(squareToCoords);

                return moves;
            } catch (error) {
                console.error("Error fetching moves:", error);
                return [];
            }
        }

        // تابع کمکی برای تبدیل از "b3" به [row,col]
        function squareToCoords(square) {
            const file = square[0].charCodeAt(0) - 97; // 'a' -> 0
            const rank = 8 - parseInt(square[1]);
            return [rank, file];
        }

        function renderBoard() {
            const chessboard = document.getElementById('chessboard');
            chessboard.innerHTML = '';

            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const square = document.createElement('div');
                    square.className = `square ${(row + col) % 2 === 0 ? 'light' : 'dark'}`;
                    square.dataset.row = row;
                    square.dataset.col = col;

                    if (board[row][col]) {
                        const piece = document.createElement('span');
                        piece.className = 'piece';
                        piece.textContent = board[row][col];
                        square.appendChild(piece);
                    }

                    square.addEventListener('click', handleSquareClick);
                    chessboard.appendChild(square);
                }
            }
        }

        function handleSquareClick(e) {
            const row = parseInt(e.currentTarget.dataset.row);
            const col = parseInt(e.currentTarget.dataset.col);

            document.querySelectorAll('.square').forEach(sq => {
                sq.classList.remove('selected', 'valid-move', 'has-piece');
            });

            if (selectedSquare) {
                const [selectedRow, selectedCol] = selectedSquare;
                const validMoves = getValidMoves(selectedRow, selectedCol);
                const isValidMove = validMoves.some(([r, c]) => r === row && c === col);

                if (isValidMove) {
                    board[row][col] = board[selectedRow][selectedCol];
                    board[selectedRow][selectedCol] = '';
                    currentTurn = currentTurn === 'white' ? 'black' : 'white';
                    document.getElementById('current-turn').textContent = currentTurn === 'white' ? 'سفید' : 'سیاه';
                    selectedSquare = null;
                    renderBoard();
                    return;
                }
            }

            const piece = board[row][col];
            if (piece && getPieceColor(piece) === currentTurn) {
                selectedSquare = [row, col];
                e.currentTarget.classList.add('selected');

                const validMoves = getValidMoves(row, col);
                validMoves.forEach(([r, c]) => {
                    const square = document.querySelector(`[data-row="${r}"][data-col="${c}"]`);
                    square.classList.add('valid-move');
                    if (board[r][c]) {
                        square.classList.add('has-piece');
                    }
                });
            } else {
                selectedSquare = null;
            }
        }

        async function onConfigChange(config) {
            document.getElementById('board-title').textContent = config.board_title || defaultConfig.board_title;
            document.getElementById('turn-text').innerHTML = `${config.turn_text || defaultConfig.turn_text} <span id="current-turn">${currentTurn === 'white' ? 'سفید' : 'سیاه'}</span>`;

            const customFont = config.font_family || defaultConfig.font_family;
            const baseFontStack = "'Vazirmatn', 'Segoe UI', Tahoma, sans-serif";
            document.body.style.fontFamily = customFont ? `${customFont}, ${baseFontStack}` : baseFontStack;

            const baseSize = config.font_size || 16;
            document.getElementById('board-title').style.fontSize = `${baseSize * 2}px`;
            document.querySelector('.turn-indicator').style.fontSize = `${baseSize * 1.125}px`;

            document.body.style.background = `linear-gradient(135deg, ${config.background_color || defaultConfig.background_color} 0%, ${config.secondary_action_color || defaultConfig.secondary_action_color} 100%)`;
            document.querySelector('.container').style.backgroundColor = config.surface_color || defaultConfig.surface_color;
            document.getElementById('board-title').style.color = config.text_color || defaultConfig.text_color;
            document.querySelector('.turn-indicator').style.color = config.text_color || defaultConfig.text_color;
        }

        if (window.elementSdk) {
            window.elementSdk.init({
                defaultConfig,
                onConfigChange,
                mapToCapabilities: (config) => ({
                    recolorables: [
                        {
                            get: () => config.background_color || defaultConfig.background_color,
                            set: (value) => {
                                config.background_color = value;
                                window.elementSdk.setConfig({ background_color: value });
                            }
                        },
                        {
                            get: () => config.surface_color || defaultConfig.surface_color,
                            set: (value) => {
                                config.surface_color = value;
                                window.elementSdk.setConfig({ surface_color: value });
                            }
                        },
                        {
                            get: () => config.text_color || defaultConfig.text_color,
                            set: (value) => {
                                config.text_color = value;
                                window.elementSdk.setConfig({ text_color: value });
                            }
                        },
                        {
                            get: () => config.primary_action_color || defaultConfig.primary_action_color,
                            set: (value) => {
                                config.primary_action_color = value;
                                window.elementSdk.setConfig({ primary_action_color: value });
                            }
                        },
                        {
                            get: () => config.secondary_action_color || defaultConfig.secondary_action_color,
                            set: (value) => {
                                config.secondary_action_color = value;
                                window.elementSdk.setConfig({ secondary_action_color: value });
                            }
                        }
                    ],
                    borderables: [],
                    fontEditable: {
                        get: () => config.font_family || defaultConfig.font_family,
                        set: (value) => {
                            config.font_family = value;
                            window.elementSdk.setConfig({ font_family: value });
                        }
                    },
                    fontSizeable: {
                        get: () => config.font_size || 16,
                        set: (value) => {
                            config.font_size = value;
                            window.elementSdk.setConfig({ font_size: value });
                        }
                    }
                }),
                mapToEditPanelValues: (config) => new Map([
                    ["board_title", config.board_title || defaultConfig.board_title],
                    ["turn_text", config.turn_text || defaultConfig.turn_text]
                ])
            });
        }

        initializeBoard();
        renderBoard();
    </script>
    <script>(function () { function c() { var b = a.contentDocument || a.contentWindow.document; if (b) { var d = b.createElement('script'); d.innerHTML = "window.__CF$cv$params={r:'99702615906570b6',t:'MTc2MTg4MjIxMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);"; b.getElementsByTagName('head')[0].appendChild(d) } } if (document.body) { var a = document.createElement('iframe'); a.height = 1; a.width = 1; a.style.position = 'absolute'; a.style.top = 0; a.style.left = 0; a.style.border = 'none'; a.style.visibility = 'hidden'; document.body.appendChild(a); if ('loading' !== document.readyState) c(); else if (window.addEventListener) document.addEventListener('DOMContentLoaded', c); else { var e = document.onreadystatechange || function () { }; document.onreadystatechange = function (b) { e(b); 'loading' !== document.readyState && (document.onreadystatechange = e, c()) } } } })();</script>
</body>
</html>